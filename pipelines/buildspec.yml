version: 0.2

run-as: root

env:
  shell: bash
  secrets-manager:
    DB_USERNAME: gardenplace-db-credentials:username
    DB_PASSWORD: gardenplace-db-credentials:password
    DB_HOST: gardenplace-db-credentials:host
    DB_PORT: gardenplace-db-credentials:port
    MAIL_USERNAME: gardenplace-mail:Username
    MAIL_PASSWORD: gardenplace-mail:Password
    MAIL_ENDPOINT: gardenplace-mail:Endpoint

phases:
  install:
    runtime-versions:
      golang: latest
      nodejs: latest
  build:
    commands:
      - cd backend/authService
      - go build
    finally:
      - echo $(ls)
  post_build:
    commands:
      - |
        echo "
        {
          \"UserDBConnectionString\": \""$DB_USERNAME":"$DB_PASSWORD"@tcp("$DB_HOST":"$DB_PORT")/gardenplace\",
          \"UseTLS\": true,
          \"Port\": 9001,
          \"AllowedOrigins\": [\"https://www.showandtell.page\"],
          \"SMTPEndpoint\": \""$MAIL_ENDPOINT"\",
          \"SMTPUsername\": \""$MAIL_USERNAME"\",
          \"SMTPPassword\": \""$MAIL_PASSWORD"\",
          \"SMTPFrom\": \"no-reply@www.showandtell.page\",
          \"SMTPFromName\": \"Gardenplace Registration\",
          \"VerifyEndpoint\": \"https://www.showandtell.page/gardenplace"
        }" > config.json
    finally:
      - echo $(ls)
      - cd
artifacts:
  files:
    - backend/authService/authService
    - backend/authService/config.json
    - appspec.yml
    - scripts/*